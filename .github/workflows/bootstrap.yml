name: Bootstrap

on:
  pull_request:
    branches:
      - main
      - develop
      - releases/**

env:
  ESLINT_NO_DEV_ERRORS: true
  TSC_COMPILE_ON_ERROR: true
  IMAGE_INLINE_SIZE_LIMIT: 0
  INLINE_RUNTIME_CHUNK: false

jobs:
  install-and-cache:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version-file: '.nvmrc'

      - name: Restore yarn cache
        uses: actions/cache@v3
        with:
          key: yarn-${{ runner.os }}-${{ github.run_id }} # Can use time based key as well
          restore-keys: |
            yarn-${{ runner.os }}

      - name: Cache Cypress binary
        uses: actions/cache@v3
        with:
          path: ~/.cache/Cypress
          key: cypress-${{ runner.os }}-cypress-${{ github.ref }}-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            cypress-${{ runner.os }}-cypress-${{ github.ref }}-${{ hashFiles('**/yarn.lock') }}

      - name: Cache Node Modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ github.ref }}-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-${{ github.ref }}-

      - name: Add environment variables
        run: yarn env app

      - name: Install Cypress & Build Project
        uses: cypress-io/github-action@v4
        with:
          # Disable running of tests within install job
          runTests: false
          build: yarn build

      - name: Verify Cypress
        env:
          # Make sure every Cypress install prints minimal information
          CI: 1
        run: |
          npx cypress cache path
          npx cypress cache list
          npx cypress verify
          npx cypress info

      - name: Save Build Folder
        uses: actions/upload-artifact@v3
        with:
          name: build
          if-no-files-found: error
          path: build

  call-pr-workflow:
    uses: ./.github/workflows/pr.yml
    needs: [install-and-cache]
  call-pr-cypress-workflow:
    uses: ./.github/workflows/pr-cypress.yml
    needs: [install-and-cache]

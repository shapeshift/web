name: CI

on:
  push:
    branches: [main, develop, release, yeet, private, beard, juice, gome, neo, arkeo, jib]
  pull_request:
    branches: [main, develop, release, yeet, private]

jobs:
  static:
    name: Static
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: OpenJDK
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '11'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: ${{ runner.os }}-node-

      - name: Yarn Install
        run: yarn install --immutable

      - name: Commitlint PR Title
        if: ${{ github.event_name == 'pull_request' }}
        env:
          TITLE: ${{ github.event.pull_request.title }}
        run: printf '%s' "$TITLE" | npx commitlint

      - name: Build Packages
        run: yarn build:packages

      - name: Cache ESLint
        uses: actions/cache@v4
        with:
          path: .eslintcache
          key: ${{ runner.os }}-eslint-${{ hashFiles('**/yarn.lock') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-eslint-${{ hashFiles('**/yarn.lock') }}-
            ${{ runner.os }}-eslint-

      - name: Cache TypeScript Build Info
        uses: actions/cache@v4
        with:
          path: tsconfig.tsbuildinfo
          key: ${{ runner.os }}-tsbuildinfo-${{ hashFiles('src/**/*.ts', 'src/**/*.tsx') }}
          restore-keys: ${{ runner.os }}-tsbuildinfo-

      - name: Lint, Type Check & Test
        run: yarn concurrently "yarn lint" "yarn type-check" "yarn test"

  deploy:
    name: Deploy
    if: contains(fromJSON('["develop", "release", "yeet", "main", "private", "beard", "juice", "gome", "neo", "arkeo", "jib"]'), github.event_name == 'pull_request' && github.head_ref || github.ref_name)
    runs-on: ubuntu-latest
    env:
      PROJECT_NAME: web
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      FLEEK_TOKEN: ${{ secrets.FLEEK_TOKEN }}
      FLEEK_PROJECT_ID: ${{ secrets.FLEEK_PROJECT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Environment (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          echo "COMMIT_SHORT_HASH=`echo ${{ github.event.pull_request.head.sha }} | cut -c1-7`" >> ${GITHUB_ENV}
          echo "CURRENT_BRANCH_NAME=${{ github.head_ref }}" >> ${GITHUB_ENV}

      - name: Setup Environment (Push)
        if: ${{ github.event_name == 'push' }}
        run: |
          echo "COMMIT_SHORT_HASH=`echo ${GITHUB_SHA} | cut -c1-7`" >> ${GITHUB_ENV}
          echo "CURRENT_BRANCH_NAME=${{ github.ref_name }}" >> ${GITHUB_ENV}

      - name: Extract Version
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [[ "$TAG" =~ ^v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            echo "version=${BASH_REMATCH[1]}" >> ${GITHUB_ENV}
          else
            echo "version=${{ env.COMMIT_SHORT_HASH }}" >> ${GITHUB_ENV}
          fi

      - name: Determine Build Mode
        run: |
          if [[ "${{ github.ref_name }}" == "main" || "${{ github.ref_name }}" == "release" || "${{ github.head_ref }}" == "main" || "${{ github.head_ref }}" == "release" ]]; then
            echo "BUILD_MODE=production" >> ${GITHUB_ENV}
          elif [[ "${{ github.ref_name }}" == "private" || "${{ github.head_ref }}" == "private" ]]; then
            echo "BUILD_MODE=private" >> ${GITHUB_ENV}
          else
            echo "BUILD_MODE=development" >> ${GITHUB_ENV}
          fi

      - name: Debug GitHub Context
        env: { CONTENT : "${{ toJson(github) }}" }
        run: "echo $CONTENT"

      - name: OpenJDK
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '11'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: ${{ runner.os }}-node-

      - name: Yarn Install
        run: yarn install --immutable

      - name: Build Web
        run: MODE=${{ env.BUILD_MODE }} DEPLOY=true VITE_VERSION=${{ env.version }} yarn build:web

      - name: Deploy
        run: npx -y wrangler@2 pages publish build --project-name="${{ env.PROJECT_NAME }}" --branch="${{ env.CURRENT_BRANCH_NAME }}" --commit-hash="${{ env.COMMIT_SHORT_HASH }}" --commit-message="${{ env.CURRENT_BRANCH_NAME }}-${{ env.COMMIT_SHORT_HASH }}"

      - name: Deploy to Fleek
        if: contains(fromJSON('["main"]'), github.event_name == 'pull_request' && github.head_ref || github.ref_name)
        run: npm i -g @fleek-platform/cli && fleek sites deploy
